<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>School Pickup & Dropoff</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0.5rem;
        }
        .container { max-width: 1200px; margin: 0 auto; width: 100%; }
        .glass-card { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 24px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            margin-bottom: 1rem; 
        }
        .header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.75rem; margin-bottom: 1rem; }
        .title { font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Person Legend & Highlighting */
        .legend { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 1rem; padding: 10px; background: #f9fafb; border-radius: 12px; }
        .legend-item { 
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; 
            cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .legend-item.active { border-color: #000; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Calendar UI */
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .month-title { font-size: 1.4rem; font-weight: 800; color: #1F2937; }
        .calendar-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.5rem; width: 100%; }
        .day-header { text-align: center; font-weight: 700; color: #6B7280; padding: 0.5rem 0; font-size: 0.75rem; text-transform: uppercase; }
        
        .day-cell { 
            min-height: 9.5rem; border: 2px solid #E5E7EB; border-radius: 14px; 
            padding: 0.5rem; position: relative; background: white; transition: 0.2s;
            display: flex; flex-direction: column; gap: 4px;
        }
        .day-cell.dimmed { opacity: 0.3; filter: grayscale(0.5); }
        .day-cell.highlighted { border-color: #667eea; box-shadow: 0 0 15px rgba(102, 126, 234, 0.4); z-index: 2; }
        
        .day-number { font-weight: 800; color: #1F2937; margin-bottom: 4px; font-size: 1.1rem; }
        .assignment { 
            border-radius: 8px; padding: 6px; font-size: 0.75rem; 
            display: flex; flex-direction: column; border-left: 3px solid;
        }
        .name-label { font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .badge { position: absolute; top: 0.5rem; right: 0.5rem; }
        .missing-dot { width: 10px; height: 10px; background: #EF4444; border-radius: 50%; box-shadow: 0 0 5px rgba(239,68,68,0.6); }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); align-items: center; justify-content: center; padding: 1rem; z-index: 100; backdrop-filter: blur(8px); }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 24px; padding: 1.5rem; width: 100%; max-width: 380px; }
        .current-status { background: #F3F4F6; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; }
        .status-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #E5E7EB; }
        .btn { padding: 0.75rem 1.25rem; border-radius: 12px; border: none; cursor: pointer; font-size: 0.9rem; font-weight: 700; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 100%; margin-top: 10px; }
        .form-input { width: 100%; padding: 0.8rem; border: 2px solid #E5E7EB; border-radius: 12px; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>
    <div class="container">
        <div class="glass-card">
            <div class="header">
                <div class="title">üìÖ Family Planner</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn" style="background:#eee" onclick="requestNotifPermission()">üîî</button>
                    <button class="btn" style="background:#eee" onclick="shareApp()">üì§</button>
                </div>
            </div>
            <div id="legendArea" class="legend">
                </div>
        </div>

        <div class="glass-card">
            <div class="calendar-nav">
                <button class="btn" style="background:#eee" onclick="previousMonth()">‚Üê</button>
                <div class="month-title" id="monthTitle"></div>
                <button class="btn" style="background:#eee" onclick="nextMonth()">‚Üí</button>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

    <div class="modal" id="dayModal">
        <div class="modal-content">
            <h3 id="modalDateTitle" style="margin-bottom:1rem; text-align: center;"></h3>
            <div class="current-status" id="modalStatusArea"></div>
            <div>
                <select id="modalType" class="form-input">
                    <option value="dropoff">Morning Dropoff</option>
                    <option value="pickup">Afternoon Pickup</option>
                </select>
                <input type="text" id="modalName" class="form-input" placeholder="Name">
                <button class="btn btn-primary" onclick="handleSave()">Save</button>
                <button class="btn" style="width:100%; margin-top:8px; background:#eee" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCD-MH83cfM6gBx7FiuuIaYlaJj6EAfY4E",
            authDomain: "school-planner-3b04b.firebaseapp.com",
            databaseURL: "https://school-planner-3b04b-default-rtdb.firebaseio.com",
            projectId: "school-planner-3b04b",
            storageBucket: "school-planner-3b04b.firebasestorage.app",
            messagingSenderId: "765909014333",
            appId: "1:765909014333:web:72e0cca49c85c2ef0e9754"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let schedule = {}, people = {}, currentDate = new Date(), selectedDateKey = null, activeHighlight = null;
        const COLORS = ['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#EF4444'];

        db.ref('/').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            schedule = data.schedule || {};
            people = data.people || {};
            renderCalendar();
            renderLegend();
            if(selectedDateKey) updateModalView();
        });

        function renderLegend() {
            const area = document.getElementById('legendArea');
            let html = '<span style="font-size:0.7rem; color:#666; width:100%; margin-bottom:5px">TAP TO HIGHLIGHT:</span>';
            Object.keys(people).forEach(name => {
                const isActive = activeHighlight === name;
                html += `<div class="legend-item ${isActive ? 'active' : ''}" 
                             style="background:${people[name].color}${isActive ? '' : '20'}; color:${isActive ? 'white' : people[name].color}" 
                             onclick="toggleHighlight('${name}')">${name}</div>`;
            });
            area.innerHTML = html;
        }

        function toggleHighlight(name) {
            activeHighlight = (activeHighlight === name) ? null : name;
            renderLegend();
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('monthTitle').textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            
            let html = '';
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].forEach(d => html += `<div class="day-header">${d}</div>`);
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const date = new Date(year, month, d);
                const dayOfWeek = date.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) continue;

                if (d === 1 && dayOfWeek > 1) {
                    for(let p = 1; p < dayOfWeek; p++) html += '<div></div>';
                }

                const key = date.toISOString().split('T')[0];
                const dayData = schedule[key] || {};
                
                // Highlighting Logic
                let highlightClass = '';
                if (activeHighlight) {
                    const isAssigned = (dayData.dropoff === activeHighlight || dayData.pickup === activeHighlight);
                    highlightClass = isAssigned ? 'highlighted' : 'dimmed';
                }

                let content = `<div class="day-number">${d}</div>`;
                content += renderRow(dayData.dropoff, '‚Üì');
                content += renderRow(dayData.pickup, '‚Üë');
                
                if (!dayData.dropoff || !dayData.pickup) content += '<div class="badge"><div class="missing-dot"></div></div>';

                html += `<div class="day-cell clickable ${highlightClass}" onclick="openModal('${key}')">${content}</div>`;
            }
            document.getElementById('calendar').innerHTML = html;
        }

        function renderRow(name, icon) {
            if (!name) return `<div style="height:32px"></div>`;
            const color = people[name]?.color || '#667eea';
            return `<div class="assignment" style="background:${color}10; color:${color}; border-color:${color}">
                        <div class="name-label">${icon} ${name}</div>
                    </div>`;
        }

        function openModal(key) {
            selectedDateKey = key;
            document.getElementById('modalDateTitle').textContent = new Date(key).toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'short' });
            updateModalView();
            document.getElementById('dayModal').classList.add('show');
        }

        function updateModalView() {
            const dayData = schedule[selectedDateKey] || {};
            document.getElementById('modalStatusArea').innerHTML = `
                <div class="status-row"><span><strong>Drop:</strong> ${dayData.dropoff || '---'}</span>${dayData.dropoff ? `<span onclick="remove('dropoff')" style="color:red">‚úï</span>` : ''}</div>
                <div class="status-row"><span><strong>Pick:</strong> ${dayData.pickup || '---'}</span>${dayData.pickup ? `<span onclick="remove('pickup')" style="color:red">‚úï</span>` : ''}</div>`;
        }

        function handleSave() {
            const name = document.getElementById('modalName').value.trim();
            const type = document.getElementById('modalType').value;
            if (!name) return;
            if (!schedule[selectedDateKey]) schedule[selectedDateKey] = {};
            schedule[selectedDateKey][type] = name;
            if (!people[name]) {
                const used = Object.values(people).map(p => p.color);
                people[name] = { color: COLORS.find(c => !used.includes(c)) || COLORS[0] };
            }
            db.ref('/').set({ schedule, people });
            document.getElementById('modalName').value = '';
        }

        function remove(type) {
            delete schedule[selectedDateKey][type];
            db.ref('/').set({ schedule, people });
        }

        function checkForReminders() {
            const now = new Date();
            if (now.getHours() === 19 && now.getMinutes() === 0) {
                const tom = new Date(); tom.setDate(tom.getDate() + 1);
                if (tom.getDay() !== 0 && tom.getDay() !== 6) {
                    const key = tom.toISOString().split('T')[0];
                    if (!schedule[key]?.dropoff || !schedule[key]?.pickup) {
                        new Notification("Family Planner", { body: "‚ö†Ô∏è Unassigned slot for tomorrow!" });
                    }
                }
            }
        }

        setInterval(checkForReminders, 60000);
        function closeModal() { document.getElementById('dayModal').classList.remove('show'); selectedDateKey = null; }
        function previousMonth() { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
        function nextMonth() { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
        function requestNotifPermission() { Notification.requestPermission(); }
        function shareApp() { navigator.clipboard.writeText(window.location.href); alert("Link copied!"); }
    </script>
</body>
</html>
