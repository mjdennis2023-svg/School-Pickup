<script type="module">
    // 1. Import Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // 2. Your Provided Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyCD-MH83cfM6gBx7FiuuIaYlaJj6EAfY4E",
        authDomain: "school-planner-3b04b.firebaseapp.com",
        databaseURL: "https://school-planner-3b04b-default-rtdb.firebaseio.com",
        projectId: "school-planner-3b04b",
        storageBucket: "school-planner-3b04b.firebasestorage.app",
        messagingSenderId: "765909014333",
        appId: "1:765909014333:web:72e0cca49c85c2ef0e9754"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'school_calendar_data');

    // --- App State ---
    let currentDate = new Date();
    let selectedDate = null;
    let schedule = {};
    let people = {};

    const NSW_HOLIDAYS_2026 = [
        { start: '2026-01-01', end: '2026-01-29', name: 'Summer Holidays' },
        { start: '2026-04-06', end: '2026-04-17', name: 'Autumn Holidays' },
        { start: '2026-06-29', end: '2026-07-10', name: 'Winter Holidays' },
        { start: '2026-09-21', end: '2026-10-02', name: 'Spring Holidays' },
        { start: '2026-12-18', end: '2027-01-28', name: 'Summer Holidays' }
    ];

    const PERSON_COLORS = ['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6', '#EF4444', '#14B8A6', '#F97316'];

    // 3. THE "SYNC ENGINE": Listen for any changes from the 5 users
    onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
            schedule = data.schedule || {};
            people = data.people || {};
            window.renderCalendar(); 
        }
    });

    // 4. ACTION: Sync data back to the cloud
    async function syncToFirebase() {
        try {
            await set(dbRef, { schedule, people });
        } catch (error) {
            console.error("Sync failed. Check your Firebase Rules!", error);
            alert("Connection error. Could not sync change.");
        }
    }

    // --- Attached to window for HTML Button Access ---
    window.addPerson = async function() {
        const nameInput = document.getElementById('personName');
        const name = nameInput.value.trim();
        if (!name || !selectedDate) return;
        
        const type = document.querySelector('input[name="scheduleType"]:checked').value;
        
        if (!schedule[selectedDate]) schedule[selectedDate] = {};
        schedule[selectedDate][type] = name;
        
        if (!people[name]) {
            const usedColors = Object.values(people).map(p => p.color);
            const availableColor = PERSON_COLORS.find(c => !usedColors.includes(c)) || PERSON_COLORS[0];
            people[name] = { color: availableColor };
        }
        
        await syncToFirebase();
        window.closeAddModal();
        nameInput.value = '';
    };

    window.removePerson = async function(event, dateKey, type) {
        event.stopPropagation();
        if (schedule[dateKey]) {
            delete schedule[dateKey][type];
            if (Object.keys(schedule[dateKey]).length === 0) delete schedule[dateKey];
            await syncToFirebase();
        }
    };

    window.renderCalendar = function() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthTitle = document.getElementById('monthTitle');
        if(monthTitle) monthTitle.textContent = currentDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        let html = '';
        ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => html += `<div class="day-header">${d}</div>`);
        for (let i = 0; i < firstDay; i++) html += '<div></div>';
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateKey = date.toISOString().split('T')[0];
            const daySchedule = schedule[dateKey] || {};
            const isHol = NSW_HOLIDAYS_2026.some(h => dateKey >= h.start && dateKey <= h.end);
            const isWknd = date.getDay() === 0 || date.getDay() === 6;
            const isClickable = !isHol && !isWknd;

            let classes = `day-cell ${isClickable ? 'clickable' : ''} ${isHol ? 'holiday' : ''} ${isWknd ? 'weekend' : ''}`;
            
            html += `
                <div class="${classes}" onclick="${isClickable ? `window.openAddModal('${dateKey}')` : ''}">
                    <div class="day-number">${day}</div>
                    ${isClickable && (!daySchedule.dropoff || !daySchedule.pickup) ? '<div class="badge"><div class="missing-dot"></div></div>' : ''}
                    ${Object.entries(daySchedule).map(([type, pName]) => {
                        const color = people[pName]?.color || '#667eea';
                        return `
                            <div class="assignment" style="background: ${color}20; border-left: 3px solid ${color}">
                                <span style="color: ${color}; font-weight:bold">${type === 'dropoff' ? '↓' : '↑'} ${pName}</span>
                                <span class="remove-btn" onclick="window.removePerson(event, '${dateKey}', '${type}')">✕</span>
                            </div>`;
                    }).join('')}
                </div>`;
        }
        document.getElementById('calendar').innerHTML = html;
        window.renderPeopleList();
    };

    window.renderPeopleList = function() {
        const container = document.getElementById('peopleSection');
        if (!container) return;
        if (Object.keys(people).length === 0) return container.innerHTML = '';
        let html = '<h4 style="margin: 1.5rem 0 1rem; font-weight:700;">Active Drivers</h4><div class="people-list">';
        Object.keys(people).forEach(name => {
            html += `<div class="person-item"><div class="person-color" style="background: ${people[name].color}"></div>${name}</div>`;
        });
        container.innerHTML = html + '</div>';
    };

    window.previousMonth = () => { currentDate.setMonth(currentDate.getMonth() - 1); window.renderCalendar(); };
    window.nextMonth = () => { currentDate.setMonth(currentDate.getMonth() + 1); window.renderCalendar(); };
    window.openAddModal = (dateKey) => { 
        selectedDate = dateKey; 
        document.getElementById('modalTitle').textContent = `Schedule: ${dateKey}`;
        document.getElementById('addModal').classList.add('show'); 
    };
    window.closeAddModal = () => document.getElementById('addModal').classList.remove('show');

    // Init
    window.renderCalendar();
</script>
