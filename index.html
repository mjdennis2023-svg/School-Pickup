<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NSW School Planner 2026</title>
    <style>
        :root {
            --primary-purple: #6c5ce7;
            --bg-light: #f4f7fe;
            --holiday-bg: #fff7ed;
            --holiday-border: #fb923c;
            --text-dark: #1F2937;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg-light);
            padding: env(safe-area-inset-top) 1rem 2rem 1rem;
        }

        .container { max-width: 1000px; margin: 0 auto; }
        .glass-card { 
            background: white; border-radius: 24px; padding: 1.5rem; 
            margin-bottom: 1.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
        }

        .calendar-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            gap: 8px; position: relative;
        }

        /* Purple Weekend Overlay */
        .calendar-grid::after {
            content: ""; position: absolute; top: 0; right: -5px;
            width: 28.8%; height: 100%; background: var(--primary-purple);
            z-index: 0; border-radius: 18px;
        }

        .day-header { text-align: center; font-weight: 700; color: #9CA3AF; font-size: 0.75rem; z-index: 1; padding: 5px; }

        .day-cell { 
            min-height: 110px; background: white; border-radius: 16px; 
            padding: 10px; position: relative; z-index: 1;
            border: 1px solid #edf2f7; display: flex; flex-direction: column;
        }

        .day-cell.weekend { background: transparent; border: 1px solid rgba(255,255,255,0.1); }
        .day-cell.weekend .day-number { color: white; }

        /* Holiday Styling */
        .day-cell.holiday { background: var(--holiday-bg); border-color: var(--holiday-border); }
        .holiday-label { font-size: 0.65rem; color: #c2410c; font-weight: 800; margin-top: 2px; line-height: 1; }

        .day-number { font-weight: 800; font-size: 1rem; }
        .missing-dot { 
            width: 10px; height: 10px; background: #EF4444; 
            border-radius: 50%; position: absolute; top: 10px; right: 10px; 
        }

        .assignment { 
            border-radius: 6px; padding: 3px 6px; font-size: 0.7rem; 
            margin-top: 4px; font-weight: 700; display: flex; justify-content: space-between;
        }

        .remove-btn { cursor: pointer; font-weight: bold; margin-left: 4px; }

        .btn { padding: 10px 18px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; }
        .btn-primary { background: var(--primary-purple); color: white; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 2rem; border-radius: 24px; width: 90%; max-width: 400px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1 id="monthTitle" style="color:var(--primary-purple)">February 2026</h1>
                <div>
                    <button class="btn" onclick="window.previousMonth()">←</button>
                    <button class="btn" onclick="window.nextMonth()">→</button>
                </div>
            </div>
        </div>

        <div class="glass-card">
            <div class="calendar-grid" id="calendar"></div>
        </div>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3 id="modalTitle">Set Schedule</h3>
            <input type="text" id="personName" placeholder="Name">
            <div style="margin-bottom:15px;">
                <label><input type="radio" name="sType" value="dropoff" checked> Dropoff</label>
                <label style="margin-left:15px;"><input type="radio" name="sType" value="pickup"> Pickup</label>
            </div>
            <button class="btn btn-primary" style="width:100%" onclick="window.addPerson()">Save</button>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="window.closeAddModal()">Cancel</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCD-MH83cfM6gBx7FiuuIaYlaJj6EAfY4E",
        authDomain: "school-planner-3b04b.firebaseapp.com",
        databaseURL: "https://school-planner-3b04b-default-rtdb.firebaseio.com",
        projectId: "school-planner-3b04b",
        storageBucket: "school-planner-3b04b.firebasestorage.app",
        messagingSenderId: "765909014333",
        appId: "1:765909014333:web:72e0cca49c85c2ef0e9754"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'school_data_root');

    // NSW 2026 School Holidays
    const NSW_HOLIDAYS = [
        { start: '2026-01-01', end: '2026-01-26', name: 'Summer' },
        { start: '2026-04-10', end: '2026-04-26', name: 'Autumn' },
        { start: '2026-07-04', end: '2026-07-19', name: 'Winter' },
        { start: '2026-09-26', end: '2026-10-11', name: 'Spring' },
        { start: '2026-12-21', end: '2026-12-31', name: 'Summer' }
    ];

    let currentDate = new Date(2026, 1, 1);
    let schedule = {}; let people = {}; let selectedDate = null;
    const COLORS = ['#8B5CF6', '#EC4899', '#F59E0B', '#10B981', '#3B82F6'];

    onValue(dbRef, (snap) => {
        const d = snap.val(); if(d){ schedule = d.schedule||{}; people = d.people||{}; render(); }
    });

    function isHoliday(dateStr) {
        return NSW_HOLIDAYS.find(h => dateStr >= h.start && dateStr <= h.end);
    }

    function render() {
        const year = currentDate.getFullYear(), month = currentDate.getMonth();
        document.getElementById('monthTitle').textContent = currentDate.toLocaleString('default', {month:'long', year:'numeric'});
        const first = new Date(year, month, 1).getDay(), days = new Date(year, month+1, 0).getDate();
        
        let h = '';
        ['SUN','MON','TUE','WED','THU','FRI','SAT'].forEach(d => h += `<div class="day-header">${d}</div>`);
        for(let i=0; i<first; i++) h += '<div></div>';
        
        for(let d=1; d<=days; d++) {
            const date = new Date(year, month, d);
            const k = date.toISOString().split('T')[0];
            const wknd = date.getDay()===0 || date.getDay()===6;
            const hol = isHoliday(k);
            const daySched = schedule[k] || {};

            let assignHtml = '';
            Object.entries(daySched).forEach(([t, n]) => {
                const c = people[n]?.color || '#667eea';
                assignHtml += `<div class="assignment" style="background:${c}20; color:${c}; border-left:3px solid ${c}">
                    ${t==='dropoff'?'↓':'↑'} ${n} <span class="remove-btn" onclick="remove(event,'${k}','${t}')">×</span></div>`;
            });

            const missing = !wknd && !hol && (!daySched.dropoff || !daySched.pickup);

            h += `<div class="day-cell ${wknd?'weekend':''} ${hol?'holiday':''}" onclick="openM('${k}')">
                <div class="day-number">${d}</div>
                ${hol ? `<div class="holiday-label">${hol.name}</div>` : ''}
                ${missing ? `<div class="missing-dot"></div>` : ''}
                ${assignHtml}
            </div>`;
        }
        document.getElementById('calendar').innerHTML = h;
    }

    window.openM = (k) => { selectedDate = k; document.getElementById('addModal').classList.add('show'); };
    window.closeAddModal = () => document.getElementById('addModal').classList.remove('show');
    
    window.addPerson = async () => {
        const n = document.getElementById('personName').value.trim();
        const t = document.querySelector('input[name="sType"]:checked').value;
        if(!n) return;
        if(!schedule[selectedDate]) schedule[selectedDate] = {};
        schedule[selectedDate][t] = n;
        if(!people[n]) people[n] = {color: COLORS[Object.keys(people).length % COLORS.length]};
        await set(dbRef, {schedule, people});
        window.closeAddModal();
    };

    window.remove = async (e, k, t) => { e.stopPropagation(); delete schedule[k][t]; await set(dbRef, {schedule, people}); };
    window.nextMonth = () => { currentDate.setMonth(currentDate.getMonth()+1); render(); };
    window.previousMonth = () => { currentDate.setMonth(currentDate.getMonth()-1); render(); };

    // 7PM Push logic remains
    setInterval(() => {
        const now = new Date();
        if(now.getHours()===19 && now.getMinutes()===0) {
            const tom = new Date(); tom.setDate(tom.getDate()+1);
            const tk = tom.toISOString().split('T')[0];
            if(tom.getDay()!==0 && tom.getDay()!==6 && !isHoliday(tk)) {
                if(!schedule[tk] || !schedule[tk].dropoff || !schedule[tk].pickup) {
                    new Notification("Schedule Missing!", {body: "Tomorrow still has empty slots."});
                }
            }
        }
    }, 60000);

    if(Notification.permission !== "granted") Notification.requestPermission();
    render();
</script>
</body>
</html>
